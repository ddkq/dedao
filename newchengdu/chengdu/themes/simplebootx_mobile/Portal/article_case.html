<!DOCTYPE html>
<html>
	<tc_include file="Public:head" />
	<link href="__TMPL__Public/css/article.css" rel="stylesheet" type="text/css">
	<title>{$article.post_title}_{$site_name}</title>
	<meta name="keywords" content="{$article.post_keywords}"/>
	<meta name="description" content="{$article.post_excerpt}" />
	</head>
	<body>

	<body>
		
		<tc_include file="Public:article_header" />
		
		<div class="font_page">
			<div class="font_page_nr">
				<h3>{$article.post_title}</h3>
				<div class="ask-doctor flex">
					<div>
						<img src="__TMPL__Public/images/article_logo.png" alt="">
						<span>成都德道口腔医院</span>
					</div>
					<div>
						<a onclick="javascript:openJesongChatByGroup(16524,20125);">问医生</a>
					</div>
				</div>
				<div class="font_content"> 
					{$article['post_phone']}
				</div>
			</div>
			
			<div class="comments" data-aid="{$article_id}" >
			
			</div>
			<ul class="pages flex">
				<li class="prev-page"></li>
				<li class="next-page"></li>
			</ul>
			
			<div class="comment_post" id="comment_post">
				<form class="comment-form" method="post">
					<div class="control-group">
						<div class="comment-postbox-wraper">
							<textarea class="form-control comment-postbox" placeholder="请输入评论内容" style="min-height:90px;" name="content"></textarea>
						</div>
					</div>
					<div class="control-group flex">
						<div class="left-input">
							<input type="text" name="full_name" value="" placeholder="姓名" />
							<input type="text" name="verify" value="" placeholder="验证码" /> 
						</div>
						<div class="right-img">
							{:sp_verifycode_img('length=4&font_size=14&width=100&height=34&charset=1234567890&use_noise=1&use_curve=0')}
						</div>

						
					</div>
					<div class="control-group">
						<button type="button" class="btn btn-primary comment-submit"><i class="fa fa-comment-o"></i><span>发表评论</span></button>
					</div>
				
					<input type="hidden" name="post_title" value="{$article.post_title}" />
					<input type="hidden" name="post_table" value="posts" />
					<input type="hidden" name="post_id" value="{$article_id}" />
					<input type="hidden" name="url" value="" />
					<input type="hidden" name="to_uid" value="0" />
					<input type="hidden" name="parentid" value="0" />
				</form>
			</div>

			
			<ul class="article_btn">
				<li class="col-xs-6">
					<a onclick="javascript:openJesongChatByGroup(16524,20125);"><i class="icon_01"></i>在线咨询<span>专家快速解答</span></a>
				</li>
				<li class="col-xs-6">
					<a href="tel:4008006161"><i class="icon_02"></i>电话咨询<span>400-800-6161</span></a>
				</li>
			</ul>
			
			<div class="related_list case_related_list">   
				<ul>
					<div class="mo_title"><h3>相关文章</h3></div>
					<volist name="hits" id="vo">
						<li><a href="{:get_article_url($vo[tid],$vo[link_type],$vo[post_murl])}">{$vo.post_title}</a></li>
					</volist>
				</ul>
	        </div>

		</div>

		<tc_include file="Public:footer" />
		
		
		<script>
			$("input[name='url']").attr('value',window.location.href);
			var page = 1;
			var aid = $('.comments').data('aid');
			var pageCount = '';
			$.post('/comment/comment/index.html',{page:page,aid:aid},function(data){
				// console.log(data)
				pageCount = data[0].page_count;
				if(pageCount == 0){
					return;
				}
				var li = '';
				var html = '';
				for(var i = 1; i <= data[0].page_count; i ++) {
					li += `<li class="page-num">${i}</li>`
				}
				for(var i = 0; i < data.length; i ++) {
					html += `<div class="comment flex" data-id="${data[i].id}">
								<div class="head-img">
									<img class="avatar" src="__TMPL__Public/images/headicon.png" class="headicon">
								</div>
								<div class="comment-body">
									<div class="comment-content">
										<p class="username">
											${data[i].full_name}
											<span class="time">${data[i].createtime}</span>
										</p>
										<p class="content-text">${data[i].content}</p>
									</div>
								    <div class="clearfix">
										<a class="comments-like click-like" href="javascript:;">
											<i class="fa fa-thumbs-o-up"></i>
											<span class="like-num">${data[i].comment_like}</span>
										</a>
										<a class="comment_reply">回复</a>
									</div>
								</div>
							</div>`;
				}
				$('.comments').html(html);
				$('.comments div').eq(0).before(`<h3>全部评论</h3>`);
				$('.pages li').eq(0).after(li);
				$('.pages li').eq(1).addClass('list-on');
				$('.next-page').html('下一页');
			});

			$('body').on('click', '.next-page', function() {
				page ++;
				page == pageCount ? $('.next-page').html('') : ''
				$('.prev-page').html('上一页');
				$('.list-on').removeClass('list-on').next().addClass('list-on');
				$('.comments').html();

				getComment(page);
			})
			
			$('body').on('click', '.prev-page', function() {
				page --;
				page == 1 ? $('.prev-page').html('') : ''
				$('.next-page').html('下一页');
				$('.list-on').removeClass('list-on').prev().addClass('list-on');
				$('.comments').html();

				getComment(page);
			})

			$('body').on('click', '.page-num', function() {
				var pageNum = $(this).text();
				$('.comments').html();
				$(this).addClass('list-on').siblings().removeClass('list-on');
				$('.prev-page').html('上一页');
				$('.next-page').html('下一页');
				if(pageNum == 1) {
					$('.prev-page').html('');
				}
				else if(pageNum == pageCount){
					$('.next-page').html('');
				}
				page = pageNum;

				getComment(pageNum);
			})

			function getComment(pag) {
				var html = '';
				$.post('/comment/comment/index.html',{page:pag,aid:aid},function(data){
					for(var i = 0; i < data.length; i ++) {
						html += `<div class="comment flex" data-id="${data[i].id}">
									<div class="head-img">
										<img class="avatar" src="__TMPL__Public/images/headicon.png" class="headicon">
									</div>
									<div class="comment-body">
										<div class="comment-content">
											<p class="username">
												${data[i].full_name}
												<span class="time">${data[i].createtime}</span>
											</p>
											<p class="content-text">${data[i].content}</p>
										</div>
									    <div class="clearfix">
											<a class="comments-like click-like" href="javascript:;">
												<i class="fa fa-thumbs-o-up"></i>
												<span class="like-num">${data[i].comment_like}</span>
											</a>
											<a class="comment_reply">回复</a>
										</div>
									</div>
								</div>`;
					}
					$('.comments').html(html);
					$('.comments div').eq(0).before(`<h3>全部评论</h3>`);
				});
			}

			$('.comment-submit').click(function(){
				var data = $('.comment-form').serializeArray();
				var content = $('.comment-postbox').text();
				if(content == ''){
					alert("评论内容不能为空");
					return false;
				}
				var name = $("input[name=full_name]").val();
				var re1 = /^[\u4E00-\u9FA5]{1,6}$/; 
				if(name == null){
					alert("姓名不能为空"); 
					return false; 
				}else if(name != null){
					if (!re1.test(name)){ 
						alert("姓名格式不正确"); 
						return false; 
					}	
				}
				$.post('/comment/comment/post.html',data,function(result){
					alert(result.info);
					window.location.reload();
				});
			});
			
			$('body').bind('click','.comments-like',function(){
				var id = $(this).parents('.comment').data('id');
				var like = $(this).find('.like-num');
				var num = parseInt(like.html());
				$(this).removeClass('comments-like');
				$.post('/comment/comment/do_like.html',{id,id},function(data){
					if(data.status){
						num+=1;
						like.html(num);
					}
				});
			});
			
			
			$('.font_content').find('img').parent('p').css('text-indent', 0);
			$('.font_content').find('img').parent('span').css('text-indent', 0);
			$('.font_content').find('img').parent('span').parent('p').css('text-indent', 0);

			$('body').on('click', '.comment_reply', function() {
				$("html,body").stop(true);
				$("html,body").animate({scrollTop: $("#comment_post").offset().top - 150}, 500);
			})
		</script>
		
		
	</body>

</html>