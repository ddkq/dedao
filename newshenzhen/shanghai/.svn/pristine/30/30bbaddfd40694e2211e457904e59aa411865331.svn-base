<admintpl file="header" />
</head>
<style>
	.d-flex {
		display: flex;
		width: 75%;
		margin: auto;
	}
	.w-50 {
		width: 50%;
	}
	.text-center {
		text-align: center;
	}
	.tips {
		color: red;
		display: none;
	}
	.add-condition:hover {
	    color: #1ea0fa;
	    border: dashed 1px #1ea0fa;
	}
	.add-condition {
	    cursor: pointer;
	    margin: auto;
	    margin-top: 8px;
	    margin-bottom: 20px;
	    background-color: #ffffff;
	    border: dashed 1px #d4d7d9;
	    text-align: center;
	    line-height: 26px;
	    line-height: 24px\9;
	    color: #a9a8a8;
	}
	.delete {
		position: absolute;
		margin-left: 15px;
		margin-top: 3px;
	}
</style>
<body>
	<div class="wrap js-check-wrap">
		<ul class="nav nav-tabs">
			<li><a href="{:U('AdminQuestionnaire/index')}" target="_self">问卷管理</a></li>
			<li class="active"><a href="javascript:;">交叉分析</a></li>
		</ul>
		<h4 class="text-center" style="margin-bottom: 25px;">{$post.title}</h4>
		
		<form action="" >
			<input type="hidden" name="id" value="{$id}" class="id">
			<div class="d-flex">
				<div class="w-50 text-center">
					<p><b>自变量X</b>（一般为样本属性，例如性别，年龄等。限2题）</p>
					<div>
						<select name="x" id="variable-x" class="w-50 x-1 select">
							<option value="0">添加自变量</option>
							<optgroup label="问卷题目"></optgroup>
						</select>
					</div>
					<div class="add-condition add-x w-50">增加条件</div>
				</div>
				<div class="w-50 text-center">
					<p><b>自变量Y</b>（您要分析的目标题目，限2题）</p>
					<div>
						<select name="y" id="variable-y" class="w-50 y-1 select">
							<option value="0">添加自变量</option>
							<optgroup label="问卷题目"></optgroup>
						</select>
					</div>
					<div class="add-condition add-y w-50">增加条件</div>
				</div>
			</div>
		</form>
		<div class="tips"></div>
		<div><a href="javascript:;" class="analysis">数据分析</a></div>
		
		<h4></h4>
		<table class="table">
			<thead>
				<tr class="table-title"></tr>
			</thead>
			<tbody class="table-content">
				<tr>
					<th scope="row"></th>
					<td></td>
					<td></td>
					<td></td>
				</tr>
			</tbody>
		</table>
		
		<table class="table">
			<thead>
				<tr class="table-title"></tr>
			</thead>
			<tbody class="table-content">
				<tr>
					<th scope="row"></th>
					<td></td>
					<td></td>
					<td></td>
				</tr>
			</tbody>
		</table>
	</div>
	<script src="__PUBLIC__/js/common.js"></script>
	<script>
		function refersh_window() {
			var refersh_time = getCookie('refersh_time');
			if (refersh_time == 1) {
				window.location = "{:U('AdminQuestionnaire/index',$formget)}";
			}
		}
		setInterval(function() {
			refersh_window();
		}, 2000);
		
		$(function() {
			var id = $('.id').val();
			var problem;
			$.post('/Questionnaire/AdminQuestionnaire/problem', {id: id}, function(data) {
				problem = data;
				var option = '';
				for(var i = 0; i < data.length; i++) {
					option += '<option value="'+ i +'">'+ data[i].name +'</option>';
				}
				$('#variable-x optgroup').after(option);
				$('#variable-y optgroup').after(option);
			});

			$('body').on('change', 'select', function(){  
				var _this = $(this).children('option:selected').text();
				var x = $('.x-1').children('option:selected').text();
				var y = $('.y-1').children('option:selected').text();

				if(XclickTime == 1) {
					var option = $('.select').not(this).children('option:selected');
					for(var i = 0; i < $('.select').not(this).children('option:selected').length; i++) {
						// console.log(option[i].text)
						if(_this == option[i].text) {
							tips(1, $(this));
							break;
						}
						else {
							tips(0);
						}
					}
				}
				else if(YclickTime == 1) {
					var option = $('.select').not(this).children('option:selected');
					for(var i = 0; i < $('.select').not(this).children('option:selected').length; i++) {
						// console.log(option[i].text)
						if(_this == option[i].text) {
							tips(1, $(this));
							break;
						}
						else {
							tips(0);
						}
					}
				}
				else {
					x == y ? tips(1, $(this)) : tips(0);
				}
			});
			function tips(num, _this) {
				num == 1 ? ($('.tips').css('display', 'block').text('题目不能重复') | _this.children('option').eq(0).attr("selected",true)) : $('.tips').css('display', 'none');
			}

			var XclickTime = 0;
			$('.add-x').on('click', function() {
				var html = '';
				XclickTime++;
				if(XclickTime > 1) {
					$('.tips').css('display', 'block').text('自变量的个数最多为两个');
					return;
				}
				else {
					html = $('#variable-x').html();
					$('#variable-x').parent().after('<div class="x-2"><select name="x-2" id="variable-x" class="w-50 select">'+ html +'</select><a href="javascript:;" class="delete">删除</a></div>');
					x2();
				}
			});
			var YclickTime = 0;
			$('.add-y').on('click', function() {
				var html = '';
				YclickTime++;
				if(YclickTime > 1) {
					$('.tips').css('display', 'block').text('自变量的个数最多为两个');
					return;
				}
				else {
					html = $('#variable-y').html();
					$('#variable-y').parent().after('<div class="y-2"><select name="y-2" id="variable-y" class="w-50 select">'+ html +'</select><a href="javascript:;" class="delete">删除</a></div>');
					y2();
				}
			});
			function x2() {
				$('body').on('click', '.x-2 .delete', function() {
					XclickTime = 0;
					$('.x-2').remove();
					$('.tips').css('display', 'none');
				});
			};
			function y2() {
				$('body').on('click', '.y-2 .delete', function() {
					YclickTime = 0;
					$('.y-2').remove();
					$('.tips').css('display', 'none');
				});
			};
			$('.analysis').on('click', function() {
				var data = $('form').serializeArray();
				// console.log(data)
				$.post('/Questionnaire/AdminQuestionnaire/analysis_data', data, function(bck) {
					// console.log(bck);
					var tr = '';
					var num = -1;
					for(var k = 0; k < bck.length; k++){
						// 先动态生成tr列的个数
						for (var i = 0; i < bck[k].content.length; i++){
							tr += '<tr></tr>';
						}
						$('.table').eq(num).find('.table-content').html(tr);
						// 在html里渲染tr列之后
						for (var i = 0; i < bck[k].content.length; i++){
							// 每次循环将内容声明为空
							var content = '';
							// 循环内容保存在content
							for(var j = 0; j < bck[k].content[i].length; j++) {
								if(j == 0) {
									content += '<th scope="row">'+bck[k].content[i][j]+'</th>';
								}
								else if(j == bck[k].content[i].length-1){
									content += '<td>'+bck[k].content[i][j]+'</td>';
								}
								else {
									content += '<td>'+bck[k].content[i][j]+'%</td>';
								}
							}
							// 在循环里通过i来找到对应tr，渲染content内容
							$('.table').eq(num).find('.table-content tr').eq(i).html(content);
							console.log(content);
						}
						var title = '';
						for(var a = 0; a < bck[k].title.length; a++) {
							title += '<th scope="col">'+bck[k].title[a]+'</th>';
						}
						console.log(title);
						$('.table').eq(num).find('.table-title').html(title);
						num++;
					}
					
				});
			});
		})
	</script>
</body>
</html>